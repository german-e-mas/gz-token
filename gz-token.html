<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<dom-module id="gz-token">
  <template>
    <style>
      #config {
        max-width: 30em;
        border: 1px solid black;
        padding: 1em;
      }

      #config > div{
        padding-top: 1em;
      }

      #config > div > input{
        float:right;
      }
    </style>
    <iron-ajax
      id='ajax'
      url=''
      handle-as='json'
      on-response='hresponse'
      on-error="herror"
      debounce-duration='300'>
    </iron-ajax>

    <div id="config"  hidden$=[[!config]]>

      <div><h1>{{title}}</h1></div>
      <div><h4>{{caption}}</h4></div>

      <div>
        Auth server URL:<input id=url value="{{url::input}}"></input>
      </div>
      <div>
        Data (JSON):<input id=data value="{{data::input}}"></input>
      </div>
      <div>
        <button on-tap="tapToken" id="buttonToken">token</button>
      </div>
      <div>
        Token: {{token}}
      </div>

      <div>
        <button on-tap="tapLogin" id="buttonLogin">login</button>
        <button on-tap="tapLogout" id="buttonLogout">logout</button>
      </div>

    </div>

  </template>

  <script src="//cdn.auth0.com/js/lock/10.1.0/lock.min.js"></script>

  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'gz-token',
      tapLogin: function() {
        this.lock.show()
      },

      tapLogout: function() {
        // Clear for refresh
        window.localStorage.removeItem("username");
        window.localStorage.removeItem("token");
        window.localStorage.removeItem("cloudsim_auth0_token");
        window.location.href = "/"
      },

      tapToken: function() {
        this.$.ajax.url = this.url + '/token'
        this.$.ajax.params = JSON.parse(this.data)
        this.$.ajax.withCredentials = true
        this.$.ajax.generateRequest()
      },
      hresponse: function(request) {
        let res = this.$.ajax.lastResponse
        const success = res.login == "success" ? true : false
        if (res.success)
        {
          this.token = res.token
          this.username = res.decoded.username

          // Set username for refresh
          window.localStorage.setItem("username", this.username);
          window.localStorage.setItem("token", this.token);

          this.fire('login', {user: this.username, token: this.token})
        }
      },
      herror: function(err) {
        console.error(err)
      },
      _requestLogin: function(profile, auth0_token) {
        // Request cloudsim-auth token
        let url = this.url
        if (!url.endsWith('/'))
          url += '/'
        url += 'token'
        this.$.ajax.url = url + '?username=' + profile.email

        this.$.ajax.headers.authorization = 'Bearer ' + auth0_token
        this.$.ajax.withCredentials = true
        this.$.ajax.generateRequest()
      },
      attached: function() {
        const that = this

        const auth0_token_item = 'cloudsim_auth0_token';

        const auth0_id = getConfig().auth0_id
        const auth0_domain = getConfig().auth0_domain

        this.lock = new Auth0Lock(auth0_id, auth0_domain);

        // This is called after page refresh due to redirect
        this.lock.on("authenticated", function(authResult) {
          // Set local storage so user is still logged in on refresh
          localStorage.setItem(auth0_token_item, authResult.idToken);

          // Login with cloudsim-auth
          that.lock.getProfile(authResult.idToken, function (err, profile) {
            if (err) {
              console.error('There was an error getting the profile: ' +
                  err.message);
              return;
            }

            that._requestLogin(profile, authResult.idToken)
          });
        });

        // When refreshing the page, check if user was already logged in
        var auth0_token = localStorage.getItem(auth0_token_item);
        if (auth0_token) {
          this.lock.getProfile(auth0_token, function (err, profile) {
            if (err) {
              console.error('There was an error getting the profile: ' +
                  err.message);
              return;
            }

            that._requestLogin(profile, auth0_token)
          });
        }

        // attached happens before the webcomponentsready event, so
        // its a good time to set a listener for it here
        window.addEventListener('WebComponentsReady', function() {
          // allow token aware components to react to login, if
          // the user is logged in but the page is reloading
          if (window.localStorage.getItem("username") != null &&
              window.localStorage.getItem("token") != null) {
            const username = window.localStorage.getItem("username")
            const token = window.localStorage.getItem("token")
            that.fire('login', {user: username, token: token})
          }
        })

        window.addEventListener('register', function(e) {
          // Login when new account was created successfully
          if (e.detail.success) {
            that.tapLogin()
          }
        });

        console.log('gz-token widget attached!')
      },
      properties: {
        // the title above the widget
        title: {
          type: String,
          value: 'Log into existing account (gz-token)',
          notify: true
        },
        // the caption under the title
        caption: {
          type: String,
          value: 'This widget allows the user to log into the system and get identity tokens from the cloudsim-auth server. These tokens are required when performing requests to cloudsim-portal and cloudsim-sim servers. A popup will show up to input username and password.',
          notify: true
        },
        data: {
          type: String,
          value: '{"role":"sim_runner"}',
          notify: true
        },
        url: {
          type: String,
          value: 'https://localhost:5050',
          notify: true
        },
        config: {
          type: Boolean,
          value: false,
        },
        username: {
          type: String,
          value: 'placeholder',
          notify: true
        },
        token: {
          type: String,
          value: '',
          notify: true
        },
      }
    })

  })()

  </script>
</dom-module>
